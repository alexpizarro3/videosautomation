# ğŸ¤– AUTOMATIZACIÃ“N COMPLETA EN GITHUB ACTIONS
# Sin necesidad de tu computadora encendida

name: ğŸ¬ TikTok Video Automation
on:
  schedule:
    # 3 veces al dÃ­a: 09:00, 15:00, 21:00 UTC
    - cron: '0 9,15,21 * * *'
  workflow_dispatch: # Permite ejecuciÃ³n manual

jobs:
  automated-video-creation:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸŒ Setup Chrome Browser
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
        
    - name: ğŸ“Š Install Chrome Driver
      run: |
        # GitHub Actions ya tiene chromedriver, pero instalamos la versiÃ³n especÃ­fica
        sudo apt-get update
        sudo apt-get install -y wget unzip
        
        # Obtener versiÃ³n de Chrome
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d'.' -f1-3)
        
        # Descargar ChromeDriver compatible
        wget -O chromedriver.zip "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION%.*}/chromedriver_linux64.zip"
        unzip chromedriver.zip
        sudo mv chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
    - name: ğŸ” Setup Environment Variables
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        VEO3_API_KEY: ${{ secrets.VEO3_API_KEY }}
        TIKTOK_USERNAME: ${{ secrets.TIKTOK_USERNAME }}
        TIKTOK_EMAIL: ${{ secrets.TIKTOK_EMAIL }}
        TIKTOK_COOKIES: ${{ secrets.TIKTOK_COOKIES }}
      run: |
        echo "GEMINI_API_KEY=${GEMINI_API_KEY}" >> .env
        echo "VEO3_API_KEY=${VEO3_API_KEY}" >> .env
        echo "TIKTOK_USERNAME=${TIKTOK_USERNAME}" >> .env
        echo "TIKTOK_EMAIL=${TIKTOK_EMAIL}" >> .env
        
        # Crear archivo de cookies desde secrets
        mkdir -p data
        echo "${TIKTOK_COOKIES}" > data/tiktok_cookies.json
        
    - name: ğŸ¯ 1. Extract TikTok Metrics
      run: |
        echo "ğŸ” Extrayendo mÃ©tricas de TikTok..."
        python analytics/tiktok_scraper.py
        
    - name: ğŸ“ˆ 2. Analyze Trends
      run: |
        echo "ğŸ“Š Analizando tendencias..."
        python analytics/trend_analyzer.py
        
    - name: ğŸ’¡ 3. Generate Content Prompts
      run: |
        echo "ğŸ§  Generando prompts optimizados..."
        python generation/prompt_generator.py
        
    - name: ğŸ¨ 4. Generate Images with Gemini
      run: |
        echo "ğŸ¨ Generando imÃ¡genes con Gemini..."
        python generation/image_generator.py
        
    - name: ğŸ¬ 5. Generate Videos with Veo3
      run: |
        echo "ğŸ¬ Generando videos con Veo3..."
        python generation/video_generator.py
        
    - name: ğŸ“± 6. Upload to TikTok
      run: |
        echo "ğŸ“± Subiendo a TikTok..."
        python upload/tiktok_uploader.py
        
    - name: ğŸ“Š 7. Log Results
      run: |
        echo "ğŸ“Š Guardando resultados..."
        python utils/logger.py --log-automation-run
        
    - name: ğŸ’¾ Archive Generated Content
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: generated-content-${{ github.run_number }}
        path: |
          data/generated/
          logs/
        retention-days: 7
        
    - name: ğŸ“§ Notify Results (Optional)
      if: failure()
      run: |
        echo "âŒ Automation failed. Check logs."
        # AquÃ­ puedes agregar notificaciones por email/Discord/Slack
        
    - name: ğŸ§¹ Cleanup Temporary Files
      if: always()
      run: |
        # Limpiar archivos temporales pero mantener logs
        find . -name "*.tmp" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + || true
